from typing import Iterator

import pandas as pd
import geopandas as gpd

from src import utils


class TestStaticStations:
    output_file_path = "data/municipalities.csv.zip"

    def _get_items(self, n: int) -> Iterator[pd.Series]:
        static_stations = pd.read_csv(self.output_file_path)
        assert len(static_stations) > 7500
        for iel in range(n):
            yield static_stations.iloc[n]

    def _get_item(self, name: str) -> pd.DataFrame:
        static_stations = (
            pd.read_csv(self.output_file_path)
            .assign(COMUNE=lambda x: x.COMUNE.apply(utils.remove_punctuations))
        )
        assert len(static_stations) >= 1
        return static_stations.loc[static_stations.COMUNE == name]

    def test_stations_id_not_duplicated(self):
        items = self._get_items(n=50)
        for row in items:
            assert set(row.stationsId_one.split(";")) & set(row.stationsId_three.split(";")) == set()
            assert set(row.stationsId_three.split(";")) & set(row.stationsId_five.split(";")) == set()

    def test_source_is_still_working(self):
        impianti_url: str = "https://www.mise.gov.it/images/exportCSV/anagrafica_impianti_attivi.csv"
        stations_tmp_df = (
            pd.read_csv(impianti_url, delimiter=";", skiprows=1, on_bad_lines="skip")
            .dropna(subset=["Latitudine", "Longitudine"])
            .reset_index(drop=True)
        )

        geometry = gpd.points_from_xy(stations_tmp_df.Longitudine, stations_tmp_df.Latitudine)

        assert len(stations_tmp_df) > 20000
        assert sum(geometry.is_valid) > 20000

    def test_stations_medolago(self):
        item = self._get_item(name='medolago').to_dict(orient='records')[0]
        assert item["stationsId_one"] == '36320;25733'
        assert item["stationsId_three"] == '50176;38229;54369;25303;11431;39057;26246;36373;15828'
        assert item["stationsId_five"] == '46031;54900;4644;33398;48550;54373;11306;15311;43387;50286;16552;11253;51452'
        assert item["centroid"] == (
            '[{"type": "Feature", "properties": {}, '
            '"geometry": {"type": "Point", "coordinates": [9.497596143966918, 45.671962801469675]}}]'
        )
        assert item["area_comune"] == (
            '[{"type": "Feature", "properties": {}, "geometry": {"type": "Polygon", '
            '"coordinates": [[[9.513578888953534, 45.673905380307], [9.516384974733961, 45.66490991954162], '
            '[9.506673813568172, 45.665637474988806], [9.501381047619299, 45.66549275972999], [9.495404242801786, '
            '45.66436376953514], [9.49063733471599, 45.66386229813464], [9.487190493135987, 45.66458811170236], '
            '[9.483712322506141, 45.66764516531807], [9.476575447983514, 45.66926830614907], [9.473843295303206, '
            '45.66954968711789], [9.477785886648213, 45.674222695897235], [9.478058229598616, 45.67358385504976], '
            '[9.478948791849644, 45.67305210347225], [9.488140262851612, 45.673013948174756], [9.499693966419487, '
            '45.677258788765435], [9.500713292288602, 45.67797317065739], [9.500139608157657, 45.678609415292385], '
            '[9.507883298148297, 45.682976649421654], [9.514068955341681, 45.67834957285891], '
            '[9.513578888953534, 45.673905380307]]]}}]'
        )

        assert item["buffer_1"] == (
            '[{"type": "Feature", "properties": {}, "geometry": {"type": "Polygon", "coordinates": '
            '[[[9.5253310370226, 45.67753028396667], [9.52578698147428, 45.676692894411865], '
            '[9.526121843511419, 45.67582786680436], [9.528926010623147, 45.66683210946499], '
            '[9.529132522945511, 45.66597117179432], [9.52921909740976, 45.66510025604013], '
            '[9.529184925066373, 45.66422755618226], [9.529030333012242, 45.66336128260872], '
            '[9.528756781103157, 45.662509584875764], [9.52836684801558, 45.66168047505441], '
            '[9.52786420679648, 45.66088175238353], [9.527253590138377, 45.66012092993757], '
            '[9.526540745712595, 45.659405163996645], [9.525732381986211, 45.658741186781995], '
            '[9.52483610503654, 45.65813524318691], [9.52386034696022, 45.65759303209579], '
            '[9.522814286551654, 45.65711965284107], [9.521707762996702, 45.656719557298544], '
            '[9.520551183391762, 45.65639650806946], [9.519355424954997, 45.65615354314013], '
            '[9.518131732845111, 45.655992947349574], [9.516891614543267, 45.65591623093154], '
            '[9.515646731785097, 45.655924115331466], [9.514408791052203, 45.656016526430896], '
            '[9.4718736719637, 45.66065553938666], [9.470629737345455, 45.66083554977292],'
            ' [9.469417253202455, 45.66110087107866], [9.46824808657146, 45.66144890663192],'
            ' [9.467133681116298, 45.66187625018099], [9.466084945238906, 45.66237871918765], '
            '[9.465112145395212, 45.66295139571176], [9.46422480565555, 45.663588674489226], ['
            '9.463431614489796, 45.66428431773581], [9.46274033968843, 45.66503151614317], '
            '[9.46215775225275, 45.66582295547289], [9.46168956000156, 45.66665088809979],'
            ' [9.461340351548069, 45.667507208806796], [9.46111355120089, 45.66838353409149],'
            ' [9.461011385237322, 45.66927128421045], [9.46103485988685, 45.670161767159335], ['
            '9.461183751249001, 45.67104626376755], [9.461456607253181, 45.671916113074985], '
            '[9.461850761650469, 45.672762797154526], [9.462362359909106, 45.67357802454906], '
            '[9.462986396768462, 45.67435381150472], [9.463716765091059, 45.67508256020323], '
            '[9.464546315540431, 45.6757571332246], [9.465466926505249, 45.67637092350878], '
            '[9.46646958358802, 45.67691791912816], [9.467544467881442, 45.67739276223332], '
            '[9.501587752476379, 45.69082156920417], [9.502714887845872, 45.69121620122337], '
            '[9.503891789262596, 45.691531519595436], [9.505107125068797, 45.691764488153275],'
            ' [9.50634919302013, 45.691912863642635], [9.507606033108983, 45.691975217351256], '
            '[9.508865542886959, 45.691950948884646], [9.51011559416844, 45.69184029195462], '
            '[9.511344149983513, 45.69164431212475], [9.512539380645995, 45.69136489653437],'
            ' [9.51368977781119, 45.69100473570112], [9.51478426541782, 45.69056729757816], '
            '[9.515812306439582, 45.69005679411799], [9.51676400441314, 45.68947814066632], '
            '[9.517630198761088, 45.688836908580114], [9.518402552989636, 45.688139271528215],'
            ' [9.519073634911, 45.68739194599431], [9.519636988118918, 45.68660212655817], '
            '[9.5253310370226, 45.67753028396667]]]}}]'
        )

